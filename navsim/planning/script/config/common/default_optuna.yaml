# config/optuna/default_optuna.yaml
optuna:
  enabled: true                 # enable Optuna mode
  study_name: navsim_search     # name of the study (change per experiment if needed)

  # Persist state so you can resume after SLURM 20h limit
  storage: sqlite:////${oc.env:SCRATCH}/navsim_workspace/optuna/${optuna.study_name}.db

  # Trial control
  n_trials: 64                  # number of trials to run
  budget_ratio: 0.25            # fraction of max_epochs per trial (e.g. 0.25 = 25%)
  lost_penalty: 0.25            # weight for penalizing val/lost_score in objective

  # Pruner (early stopping)
  reduction_factor: 3           # how aggressively to prune
  min_resource: 1               # minimum epochs before pruning
  min_early_stopping_rate: 0    # wait k halving steps before pruning (0 = prune ASAP)

  # Search spaces (suggestions inside train_once)
tuning:
  # Objective config (no hardcoded metric names in code)
  objective:
    maximize: "val/score_epoch"         # PRIMARY_MONITOR
    penalties:
      - metric: "val/lost_score"       # each: score -= weight * metric
        weight: 0.10

  # Global budget overrides (optional; your optuna.* still applies)
  budget_ratio: 0.25

  # Generic parameter space
  # Each item can be:
  #   - a single param spec
  #   - a "one_of" group (mutually exclusive branches)
  space:
    - name: mix_weight
      path: agent.loss.score_mixing_weight
      type: float
      low: 1e-3
      high: 5e-1
      log: true

    - name: top_k_num
      path: agent.loss.top_k_scores
      type: categorical
      choices: [1, 3, 5, 10]

    - name: class_weighting
      path: agent.loss.score_class_weighing
      type: categorical
      choices: [true, false]

    # Mutually exclusive selection: fusion OR rerank
    - group: selection_mode
      one_of:
        - name: fusion
          set:                         # flags to enforce when this branch is chosen
            agent.config.fuse_logits: true
            agent.config.re_rank_logits: false
          params:
            - name: fusion_alpha
              path: agent.config.fuse_logits_alpha
              type: float
              low: 0.2
              high: 0.8

        - name: rerank
          set:
            agent.config.fuse_logits: false
            agent.config.re_rank_logits: true
          params:
            - name: re_rank_shortlist
              path: agent.config.re_rank_shortlist
              type: categorical
              choices: [10, 20, 40]
